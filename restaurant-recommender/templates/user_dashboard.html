{% extends 'base.html' %}
{% block title %}User Dashboard{% endblock %}
{% block content %}
<div class="dashboard-welcome-center">
	<h2 style="margin-bottom: 0.75rem;">Welcome, {{ user.username if user and user.username else 'User' }}!</h2>
	<p style="margin-bottom: 0.75rem;">Find the best restaurants tailored to your taste</p>
	<p>What are you craving?</p>
</div>

<div class="dashboard-vertical">
	<div class="dashboard-query-center">
		<form id="restaurant-query-form" method="POST" action="/query-restaurants" class="dashboard-query-form">
			<textarea id="restaurant-query" name="restaurant_query" placeholder="e.g. give me good restaurants in Nairobi with fish food" required class="dashboard-query-textarea"></textarea>
			<button type="submit">Search Restaurants</button>
		</form>
	</div>

	<!-- Loading Animation -->
	<div id="loading-container" style="display: none;">
		<div class="loading-card">
			<div class="loading-spinner"></div>
			<h3 id="loading-message">Searching for restaurants...</h3>
			<p id="loading-submessage">This may take 30-60 seconds</p>
		</div>
	</div>

	<!-- Results Section -->
	<div style="margin-bottom:0.5em; margin-top:-2.5em;">
		{% if restaurants %}
				<form action="{{ url_for('download_recommendations') }}" method="post" style="margin-top:0; margin-bottom:0;">
					<input type="hidden" name="restaurants" value='{{ restaurants|tojson|safe }}'>
					<input type="hidden" name="restaurant_query" value="{{ request.form.restaurant_query if request.form.restaurant_query else '' }}">
					<button type="submit" class="header-btn">Download PDF</button>
				</form>
		{% endif %}
	</div>
	<div id="restaurant-results" class="dashboard-results">
		{% if restaurants %}
			<h3>Results for: "{{ request.form.restaurant_query if request.form.restaurant_query else '' }}"</h3>
			<h4>{{ restaurants|length }} Restaurant{{ 's' if restaurants|length != 1 else '' }} Found</h4>
			<div class="restaurant-row-container">
				{% for r in restaurants %}
					{% if loop.index0 % 3 == 0 %}
						<div class="restaurant-row">
					{% endif %}
					<div class="restaurant-card">
						<h4>{{ r.name }}</h4>
						<p><strong>‚≠ê Rating:</strong> {{ r.rating if r.rating else 'N/A' }}</p>
						<p><strong>üìç Address:</strong> {{ r.address }}</p>
						<p><strong>üéØ Match Score:</strong> {{ r.match_score }}</p>
						<p><strong>üí≠ Overall Sentiment:</strong> {{ r.overall_sentiment }}</p>
						
						<p><strong>Key Aspects:</strong></p>
						{% if r.aspect_sentiments and r.aspect_sentiments|length > 0 %}
							<ul class="aspect-list">
							{% for aspect, sentiment in r.aspect_sentiments.items() %}
								<li>{{ aspect }}: {{ sentiment }}</li>
							{% endfor %}
							</ul>
						{% else %}
							<span class="no-data">No aspects available</span>
						{% endif %}
						
						<p><strong>Sample Reviews:</strong></p>
						{% if r.sample_reviews and r.sample_reviews|length > 0 %}
							<ul class="review-list">
							{% for review in r.sample_reviews %}
								<li>
									<em>
									"
									{% set aspects = review.aspect if review.aspect is iterable and review.aspect is not string else review.aspect.split(',') %}
									{% set aspect_words = aspects | map('lower') | list %}
									{% set stopwords = [
										'the', 'and', 'a', 'an', 'of', 'for', 'to', 'in', 'on', 'at', 'with', 'is', 'are', 'was', 'were', 'be', 'by', 'as', 'it', 'this', 'that', 'from', 'or', 'but', 'so', 'if', 'then', 'than', 'which', 'who', 'what', 'where', 'when', 'how', 'has', 'have', 'had', 'do', 'does', 'did', 'can', 'could', 'should', 'would', 'will', 'just', 'about', 'into', 'out', 'up', 'down', 'over', 'under', 'again', 'more', 'most', 'some', 'such', 'no', 'not', 'only', 'own', 'same', 'too', 'very', 's', 't', 'd', 'll', 'm', 'o', 're', 've', 'y'
									] %}
									{% set query_words = (request.form.restaurant_query if request.form.restaurant_query else '').split(' ') %}
									{% set query_words = query_words | map('lower') | reject('in', stopwords) | list %}
									{% set all_synonyms = [] %}
									{% for aspect in aspects %}
										{% set aspect_syns = [] %}
										{% if aspect_synonyms and aspect_synonyms[aspect.strip().lower()] %}
											{% set aspect_syns = aspect_synonyms[aspect.strip().lower()] %}
										{% endif %}
										{% set all_synonyms = all_synonyms + (aspect_syns | map('lower') | list) %}
									{% endfor %}
									{% set positive_words = [
										'good','great','excellent','amazing','delicious','tasty','yummy','wonderful','awesome','perfect','outstanding','fantastic','superb','love','loved','enjoy','enjoyed','pleasant','satisfying','impressive','favorite','best','nice','fresh','friendly','welcoming','happy','recommend','recommended','memorable','top','positive','beautiful','clean','neat','affordable','reasonable','quick','fast','prompt','cozy','peaceful','spacious','helpful','attentive','professional','polite','courteous','responsive','filling','hearty','generous','adequate','enough','well','smooth','fun','funny','entertaining','safe','secure','convenient','accessible','organized','tidy','spotless','sanitary','hygienic','special','unique','creative','modern','stylish','romantic','intimate','lively','calm','bright','cheerful','efficient','value','worth','deal','bargain','discount','offer','special','happy hour','live music','family','kid','play','outdoor','wifi','power','charging','socket','plug','rest area','wash area','handwash','kids area','play area','outdoor seating','non-smoking','first aid','recommendation','will return','come back','regular','expectation','exceeded','met expectations','feedback','review','opinion'
									] %}
									{% set negative_words = [
										'bad','poor','terrible','awful','disappointing','unpleasant','unhappy','unfriendly','rude','impolite','unhelpful','slow','late','dirty','filthy','messy','crowded','cramped','noisy','loud','expensive','pricey','overpriced','underwhelming','bland','stale','burnt','raw','greasy','oily','dry','overcooked','undercooked','cold','soggy','small','tiny','insufficient','not enough','unorganized','confusing','difficult','problem','issue','complaint','wait','waiting','queue','delay','lag','rush','missing','out of stock','unavailable','broken','unsafe','dangerous','harassment','robbery','lost','forgot','forgotten','wrong','incorrect','mistake','error','negative','dislike','hate','disliked','disappoint','disappointed','disappointing','not recommend','never return','never come back','waste','money','uncomfortable','unpleasant','smell','odor','garbage','trash','waste','leak','spilled','poorly packed','no wifi','no power','no charging','no socket','no plug','no rest area','no wash area','no handwash','no kids area','no play area','no outdoor seating','smoking','no first aid','did not meet','not met','not exceeded','not satisfied','not happy','not impressed','not memorable','not favorite','not best','not top','not positive','not beautiful','not clean','not neat','not affordable','not reasonable','not quick','not fast','not prompt','not cozy','not peaceful','not spacious','not helpful','not attentive','not professional','not polite','not courteous','not responsive','not filling','not hearty','not generous','not adequate','not enough','not well','not smooth','not fun','not funny','not entertaining','not safe','not secure','not convenient','not accessible','not organized','not tidy','not spotless','not sanitary','not hygienic','not special','not unique','not creative','not modern','not stylish','not romantic','not intimate','not lively','not calm','not bright','not cheerful','not efficient','not value','not worth','not deal','not bargain','not discount','not offer','not special','not happy hour','not live music','not family','not kid','not play','not outdoor','not wifi','not power','not charging','not socket','not plug','not rest area','not wash area','not handwash','not kids area','not play area','not outdoor seating','not non-smoking','not first aid','not recommendation','not will return','not come back','not regular','not expectation','not exceeded','not met expectations','not feedback','not review','not opinion'
									] %}
									{% for word in review.text.split(' ') %}
										{% set w = word.lower().strip('.,!?') %}
										{% set is_bold = false %}
										{% if w in aspect_words or w in query_words or w in all_synonyms %}
											{% set is_bold = true %}
										{% endif %}
										{# Only bold if the word is not a substring of another word #}
										{% if is_bold and word|length == w|length %}
											<strong>{{ word }}</strong>
										{% else %}
											{{ word }}
										{% endif %}
										{% if not loop.last %} {% endif %}
									{% endfor %}
									"
									</em><br>
									<small>
										Sentiment: <strong>{{ review.sentiment }}</strong> |
										Aspects:
										{% for aspect in aspects %}
											<strong>{{ aspect.strip() }}</strong>{% if not loop.last %}, {% endif %}
										{% endfor %}
									</small>
								</li>
							{% endfor %}
							</ul>
						{% else %}
							<span class="no-data">No reviews available</span>
						{% endif %}
					</div>
					{% if loop.index0 % 3 == 2 or loop.last %}
						</div>
					{% endif %}
				{% endfor %}
			</div>
		{% endif %}
	</div>
</div>

<style>
/* Loading Animation Styles */
.loading-card {
	background: white;
	padding: 3rem;
	border-radius: 20px;
	box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
	text-align: center;
	max-width: 500px;
	margin: 2rem auto;
	animation: fadeIn 0.3s;
}

.loading-spinner {
	width: 60px;
	height: 60px;
	border: 5px solid #e2e8f0;
	border-top: 5px solid #667eea;
	border-radius: 50%;
	margin: 0 auto 1.5rem;
	animation: spin 1s linear infinite;
}

@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}

#loading-message {
	color: #2d3748;
	margin-bottom: 0.5rem;
	font-size: 1.5rem;
}

#loading-submessage {
	color: #718096;
	font-size: 1rem;
}

/* Enhanced Restaurant Cards */
.restaurant-card h4 {
	color: #667eea;
	font-size: 1.4rem;
	margin-bottom: 1rem;
	border-bottom: 2px solid #e2e8f0;
	padding-bottom: 0.5rem;
}

.restaurant-card p {
	margin-bottom: 0.75rem;
	line-height: 1.6;
}

.restaurant-card strong {
	color: #4a5568;
}

.no-data {
	color: #a0aec0;
	font-style: italic;
}

.review-list {
	list-style: none;
	padding: 0;
}

.review-list li {
	background: #f7fafc;
	padding: 0.75rem;
	margin-bottom: 0.5rem;
	border-radius: 8px;
	border-left: 3px solid #667eea;
}

.review-list em {
	color: #2d3748;
	display: block;
	margin-bottom: 0.5rem;
}

.review-list small {
	color: #718096;
}
</style>

<script>
var USER_EMAIL_FROM_TEMPLATE = {{ user.email|tojson | safe }};

// Show loading animation on form submit
document.getElementById('restaurant-query-form').addEventListener('submit', function() {
	document.getElementById('loading-container').style.display = 'block';
	document.getElementById('restaurant-results').style.display = 'none';
	
	// Update loading messages
	const messages = [
		{ main: "Searching for restaurants...", sub: "This may take 30-60 seconds" },
		{ main: "Fetching reviews...", sub: "Analyzing customer feedback" },
		{ main: "Calculating match scores...", sub: "Finding the best options for you" },
		{ main: "Almost there...", sub: "Preparing your results" }
	];
	
	let currentMessage = 0;
	const interval = setInterval(() => {
		currentMessage = (currentMessage + 1) % messages.length;
		document.getElementById('loading-message').textContent = messages[currentMessage].main;
		document.getElementById('loading-submessage').textContent = messages[currentMessage].sub;
	}, 8000);
	
	// Clear interval when page reloads (form submission completes)
	window.addEventListener('beforeunload', () => clearInterval(interval));
});
</script>
<script type="module" src="/static/js/auth.js"></script>
{% endblock %}